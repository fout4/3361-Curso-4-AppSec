name: TruffleHog Scan Test

on:
 pull_request:
   branches:
     - main

jobs:
 trufflehog:
   runs-on: ubuntu-latest
   
   steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up trufflehog
      run: |
        docker pull trufflesecurity/trufflehog:latest
      
    - name: Run trufflehog
      id: trufflehog
      run: |
        output=$(docker run --name trufflehog -v "$(pwd):/workdir" trufflesecurity/trufflehog:latest github --repo https://github.com/${{ github.repository }} --exclude-paths=/pwd/trufflehog-exclude-path.txt)
        trufflehog_output=$(printf '%s' "$output" | tr -d '\r')
        if [[ "$trufflehog_output" == *"Found unverified result"* || "$trufflehog_output" == *"Found verified result"* ]]; then
          echo "Secret detected! Extracting details..."
          commit=$(printf '%s' "$trufflehog_output" | sed -n 's/^Commit: //p' | head -n1)
          file=$(printf '%s' "$trufflehog_output" | sed -n 's/^File: //p' | head -n1)
          raw_result=$(printf '%s' "$trufflehog_output" | sed -n '/^Raw result:/,/^Commit:/p' | sed '1d;$d')
          {
          echo "found_secret=true"
          echo "trufflehog_commit=$commit"
          echo "trufflehog_file=$file"
          printf 'trufflehog_raw_result<<EOF\n%s\nEOF\n' "$raw_result"
          } >> "$GITHUB_OUTPUT"
        else
          echo "No secrets found."
          echo "found_secret=false" >> "$GITHUB_OUTPUT"
        fi

    - name: Create issue
      if: ${{ steps.trufflehog.outputs.found_secret == 'true' }}
      env:
          GH_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      run: |
        echo "$trufflehog_output"
        commit="${{ steps.trufflehog.outputs.trufflehog_commit }}"
        file="${{ steps.trufflehog.outputs.trufflehog_file }}"
        raw_result="${{ steps.trufflehog.outputs.trufflehog_raw_result }}"

        issue_body="**TruffleHog detected a potential secret** üê∑üîë  
        **Commit:** $commit  
        **File:** $file  
        **Raw result:**  
        \`\`\`
        $raw_result
        \`\`\`"

        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/fout4/3361-Curso-4-AppSec/issues \
          -d "{\"title\":\"TruffleHog found a secret\",\"body\":\"$issue_body\",\"labels\":[\"bug\"]}" \