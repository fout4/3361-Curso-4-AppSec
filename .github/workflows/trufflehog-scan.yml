name: TruffleHog Scan Test

on:
 pull_request:
   branches:
     - main

jobs:
 trufflehog:
   runs-on: ubuntu-latest

   steps:
    - name: Checkout repository
      uses: actions/checkout@v2
      with:
        fetch-depth: 0

    - name: Set up trufflehog
      run: |
        docker pull trufflesecurity/trufflehog:latest
      
    - name: Run trufflehog
      id: trufflehog
      run: |
        trufflehog_output=$(docker run --name trufflehog -v "$(pwd):/workdir" trufflesecurity/trufflehog:latest git file:///workdir --since-commit ${{ github.event.pull_request.base.sha }} --json)
        echo "$trufflehog_output" > trufflehog_output.json

    - name: Create issue
      run: |
        echo "$trufflehog_output"
        result_count=$(echo "$trufflehog_output" | jq -r '. | length')

        if [ "$result_count" -gt 0 ]; then
        echo "ðŸš¨ Found $result_count potential secrets."
        commit=$(echo "$trufflehog_output" | jq -r '.[0].SourceMetadata.Data.Git.commit')
        file=$(echo "$trufflehog_output" | jq -r '.[0].SourceMetadata.Data.Git.file')
        line=$(echo "$trufflehog_output" | jq -r '.[0].SourceMetadata.Data.Git.line')
        detector=$(echo "$trufflehog_output" | jq -r '.[0].DetectorName')
        verified=$(echo "$trufflehog_output" | jq -r '.[0].Verified')
        secret_snippet=$(echo "$trufflehog_output" | jq -r '.[0].Raw' | head -c 20)

        issue_body="**TruffleHog found a secret!**
        \n\n**Commit:** $commit
        \n**File:** $file (line $line)
        \n**Detector:** $detector
        \n**Verified:** $verified
        \n**Snippet:** \`${secret_snippet}...\`
        \n\n<details><summary>Full output</summary>\n\n\`\`\`json\n$trufflehog_output\n\`\`\`\n</details>"
          
        curl -L \
          -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.ACCESS_TOKEN }}" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          https://api.github.com/repos/fout4/3361-Curso-4-AppSec/issues \
          -d "{\"title\":\"TruffleHog found a secret\",\"body\":\"$issue_body\",\"labels\":[\"bug\"]}" \
        exit 1
        fi
      env:
        trufflehog_output: ${{ steps.trufflehog.outputs.trufflehog_output }}    